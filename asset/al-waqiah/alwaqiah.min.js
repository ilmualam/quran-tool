document.addEventListener('DOMContentLoaded', function() {
    (function() {
        const surahData = [];
        const surahNumber = 56; // Al-Waqiah
        
        const ayahListContainer = document.getElementById('ilmu-saw-ayah-list');
        const audioPlayer = document.getElementById('ilmu-saw-audio-player');
        const playPauseAllBtn = document.getElementById('ilmu-saw-play-pause-all');
        const autoplayToggle = document.getElementById('ilmu-saw-autoplay-toggle');
        const loadingIndicator = document.getElementById('ilmu-saw-loading');
        const controlsContainer = document.querySelector('.ilmu-saw-controls');
        const notification = document.getElementById('ilmu-saw-copy-notification');

        let currentAyahIndex = -1;
        let isPlaying = false;
        let bookmarkedAyahs = new Set(JSON.parse(localStorage.getItem(`bookmarked_${surahNumber}`)) || []);

        async function fetchSurahData() {
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/editions/ar.alafasy,ms.basmeih`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if(loadingIndicator) loadingIndicator.style.display = 'none';
                if(controlsContainer) controlsContainer.style.display = 'flex';

                const arabicAyahs = data.data[0].ayahs;
                const malayAyahs = data.data[1].ayahs;

                for (let i = 0; i < arabicAyahs.length; i++) {
                    surahData.push({
                        number: arabicAyahs[i].numberInSurah,
                        arabic: arabicAyahs[i].text,
                        translation: malayAyahs[i].text,
                        audio: arabicAyahs[i].audio
                    });
                }
                renderAyahs();
            } catch (error) {
                if(loadingIndicator) loadingIndicator.innerHTML = '<p style="color:red;">Maaf, gagal memuatkan data Surah Al-Waqiah. Sila cuba lagi nanti.</p>';
                console.error('Error fetching Surah Al-Waqiah data:', error);
            }
        }

        function renderAyahs() {
            if (!ayahListContainer) return;
            ayahListContainer.innerHTML = '';
            surahData.forEach((ayah, index) => {
                const ayahDiv = document.createElement('div');
                ayahDiv.className = 'ilmu-saw-ayah';
                ayahDiv.id = `ilmu-saw-ayah-${index}`;
                if (bookmarkedAyahs.has(index)) {
                    ayahDiv.classList.add('ilmu-saw-bookmarked');
                }

                const bookmarkIcon = bookmarkedAyahs.has(index) 
                    ? `<svg fill="#ffc107" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"></path></svg>`
                    : `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"></path></svg>`;

                ayahDiv.innerHTML = `
                    <div class="ilmu-saw-ayah-header">
                        <span class="ilmu-saw-ayah-number">Al-Waqiah : Ayat ${ayah.number}</span>
                        <button class="ilmu-saw-action-button" data-action="play" data-index="${index}" aria-label="Mainkan Ayat ${ayah.number}">
                             <svg fill="#249749" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                        </button>
                    </div>
                    <p class="ilmu-saw-arabic">${ayah.arabic}</p>
                    <p class="ilmu-saw-translation">${ayah.translation}</p>
                    <div class="ilmu-saw-ayah-actions">
                         <button class="ilmu-saw-action-button" data-action="copy" data-index="${index}">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                            Copy
                        </button>
                        <button class="ilmu-saw-action-button" data-action="share" data-index="${index}">
                           <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.11C7.5 7.61 6.79 7.3 6 7.3c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg>
                            Share
                        </button>
                         <button class="ilmu-saw-action-button" data-action="bookmark" data-index="${index}">
                            ${bookmarkIcon}
                            Bookmark
                        </button>
                    </div>
                `;
                ayahListContainer.appendChild(ayahDiv);
            });
            addEventListeners();
        }
        
        function handleAction(e) {
            const target = e.target.closest('.ilmu-saw-action-button');
            if (!target) return;

            const action = target.dataset.action;
            const index = parseInt(target.dataset.index);
            const ayahData = surahData[index];
            const textToCopy = `Surah Al-Waqiah, Ayat ${ayahData.number}:\n\n${ayahData.arabic}\n\nTerjemahan: "${ayahData.translation}"\n\n- Dari ilmualam.com`;

            if (action === 'play') playAyah(index);
            if (action === 'copy') copyToClipboard(textToCopy);
            if (action === 'share') shareAyah(textToCopy);
            if (action === 'bookmark') toggleBookmark(index, target);
        }

        function addEventListeners() {
            ayahListContainer.addEventListener('click', handleAction);
            playPauseAllBtn.addEventListener('click', () => isPlaying ? stopPlayback() : playAyah(0));
            audioPlayer.addEventListener('ended', () => {
                if (autoplayToggle.checked && currentAyahIndex < surahData.length - 1) {
                    playAyah(currentAyahIndex + 1);
                } else {
                    stopPlayback();
                }
            });
        }

        function playAyah(index) {
            if (index >= surahData.length || index < 0) return stopPlayback();
            currentAyahIndex = index;
            audioPlayer.src = surahData[index].audio;
            audioPlayer.play().catch(e => console.error("Audio error:", e));
            isPlaying = true;
            updateUIForPlayback();
        }

        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isPlaying = false;
            currentAyahIndex = -1;
            updateUIForPlayback();
        }

        function updateUIForPlayback() {
            playPauseAllBtn.textContent = isPlaying ? 'Hentikan Bacaan' : 'Mula Bacaan';
            document.querySelectorAll('.ilmu-saw-ayah').forEach((div, idx) => {
                const playBtnIcon = div.querySelector('[data-action="play"] svg path');
                if (idx === currentAyahIndex && isPlaying) {
                    div.classList.add('ilmu-saw-playing');
                    if (playBtnIcon) playBtnIcon.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z'); // Pause icon
                    div.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    div.classList.remove('ilmu-saw-playing');
                    if (playBtnIcon) playBtnIcon.setAttribute('d', 'M8 5v14l11-7z'); // Play icon
                }
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => showNotification());
        }

        async function shareAyah(text) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Ayat dari Surah Al-Waqiah',
                        text: text,
                        url: window.location.href
                    });
                } catch(err) { console.error('Share failed:', err); }
            } else {
                copyToClipboard(text); // Fallback for browsers without share API
            }
        }
        
        function toggleBookmark(index, button) {
            const ayahDiv = document.getElementById(`ilmu-saw-ayah-${index}`);
            if (bookmarkedAyahs.has(index)) {
                bookmarkedAyahs.delete(index);
                ayahDiv.classList.remove('ilmu-saw-bookmarked');
                button.innerHTML = `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"></path></svg> Bookmark`;
            } else {
                bookmarkedAyahs.add(index);
                ayahDiv.classList.add('ilmu-saw-bookmarked');
                 button.innerHTML = `<svg fill="#ffc107" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"></path></svg> Bookmarked`;
            }
            localStorage.setItem(`bookmarked_${surahNumber}`, JSON.stringify([...bookmarkedAyahs]));
        }
        
        function showNotification() {
            if (!notification) return;
            notification.style.opacity = 1;
            setTimeout(() => { notification.style.opacity = 0; }, 2000);
        }

        fetchSurahData();
    })();
});
