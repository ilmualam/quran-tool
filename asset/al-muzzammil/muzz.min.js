/*!
 * Surah Al-Muzzammil Interactive Reader
 * Version: 1.0.0
 * Author: IlmuAlam.com
 * License: MIT
 * Description: Interactive Quran reader for Surah Al-Muzzammil with audio, rumi, translation, and bookmark features
 * API: Al-Quran Cloud (https://alquran.cloud/api)
 * Copyright (c) 2025 IlmuAlam.com
 */
(function () {
  "use strict";

  var CONFIG = {
    surahId: 73,
    containerId: "surah-reader-tool",
    reciterEdition: 3, // index dalam response (ar.alafasy)
    autoplayDefault: false
  };

  var container = document.getElementById(CONFIG.containerId);
  if (!container) return;

  // State
  var state = {
    ayahs: [],
    currentIndex: null,
    isPlaying: false,
    autoplay: CONFIG.autoplayDefault,
    mode: "all" // "all" atau "single"
  };

  var audio = new Audio();
  audio.preload = "auto";

  audio.addEventListener("ended", function () {
    handleEnded();
  });

  // Utility
  function $(selector, scope) {
    return (scope || document).querySelector(selector);
  }

  function $all(selector, scope) {
    return Array.prototype.slice.call(
      (scope || document).querySelectorAll(selector)
    );
  }

  function setText(el, text) {
    if (el) el.textContent = text;
  }

  // Build skeleton UI
  container.innerHTML = [
    '<div class="ilm-mt-wrapper">',
    '  <div class="ilm-mt-header">',
    '    <div class="ilm-mt-title-row">',
    '      <h3 class="ilm-mt-title">üéß Bacaan Interaktif Surah Al-Muzzammil</h3>',
    '      <small class="ilm-mt-sub">Audio setiap ayat + rumi + terjemahan Melayu</small>',
    "    </div>",
    '    <div class="ilm-mt-controls">',
    '      <button type="button" class="ilm-mt-btn" data-role="play-all">‚ñ∂ Play All</button>',
    '      <button type="button" class="ilm-mt-btn ilm-mt-btn-ghost" data-role="pause-all" disabled>‚è∏ Henti</button>',
    '      <label class="ilm-mt-toggle">',
    '        <input type="checkbox" data-role="autoplay-toggle"' +
      (CONFIG.autoplayDefault ? " checked" : "") +
      ">",
    '        <span>Auto Play ayat seterusnya</span>',
    "      </label>",
    '      <div class="ilm-mt-mode">',
    '        <label><input type="radio" name="mt-mode" value="all" checked> Dengar semua ayat</label>',
    '        <label><input type="radio" name="mt-mode" value="single"> Dengar ayat dipilih sahaja</label>',
    "      </div>",
    '      <div class="ilm-mt-status">',
    '        <span data-role="current-status">Sedia dimainkan</span>',
    "      </div>",
    "    </div>",
    "  </div>",
    '  <div class="ilm-mt-body" data-role="ayah-list">',
    "    <p>Sedang memuatkan ayat-ayat Surah Al-Muzzammil...</p>",
    "  </div>",
    "</div>"
  ].join("");

  // Minimal CSS scoped
  injectCss(
    ".ilm-mt-wrapper{margin:24px 0;border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;background:#ffffff}" +
      ".ilm-mt-header{padding:16px 16px 12px;background:linear-gradient(135deg,#0c3808 0%,#249749 100%);color:#fff}" +
      ".ilm-mt-title{margin:0;font-size:1.1rem;font-weight:600}" +
      ".ilm-mt-sub{opacity:.9}" +
      ".ilm-mt-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}" +
      ".ilm-mt-btn{border:none;border-radius:999px;padding:8px 16px;font-size:.9rem;cursor:pointer;font-weight:600;background:#fff;color:#0c3808;transition:all .2s}" +
      ".ilm-mt-btn:hover{opacity:.95;transform:translateY(-1px)}" +
      ".ilm-mt-btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}" +
      ".ilm-mt-btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.8);color:#fff}" +
      ".ilm-mt-toggle{display:flex;align-items:center;gap:4px;font-size:.8rem;opacity:.95}" +
      ".ilm-mt-toggle input{accent-color:#ffd54f}" +
      ".ilm-mt-mode{display:flex;gap:8px;font-size:.78rem;flex-wrap:wrap}" +
      ".ilm-mt-mode input{accent-color:#fff}" +
      ".ilm-mt-status{font-size:.78rem;opacity:.9;margin-left:auto}" +
      ".ilm-mt-body{padding:12px 12px 16px;max-height:1200px;overflow-y:auto;background:#f8faf9}" +
      ".ilm-mt-ayah{background:#fff;border-radius:10px;padding:10px 12px;margin-bottom:8px;border:1px solid #e0f0e9;display:flex;flex-direction:column;gap:6px}" +
      ".ilm-mt-ayah-header{display:flex;justify-content:space-between;align-items:center;gap:8px}" +
      ".ilm-mt-ayah-num{font-weight:700;color:#0c3808;font-size:.85rem}" +
      ".ilm-mt-ayah-ar{font-size:1.4rem;line-height:1.7;text-align:right;font-family:'Scheherazade', 'Amiri', 'Traditional Arabic', serif;color:#0c3808}" +
      ".ilm-mt-ayah-rumi{font-size:.85rem;padding:6px 8px;background:#ecfdfa;border-radius:6px;border:1px dashed #0c3803}" +
      ".ilm-mt-ayah-ms{font-size:.82rem;color:#333}" +
      ".ilm-mt-ayah-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}" +
      ".ilm-mt-ayah-btn{border:none;border-radius:999px;padding:4px 10px;font-size:.78rem;cursor:pointer;background:#249749;color:#fff;display:inline-flex;align-items:center;gap:4px}" +
      ".ilm-mt-ayah-btn.ghost{background:#fff;color:#249749;border:1px solid #249749}" +
      ".ilm-mt-ayah.active{border-color:#249749;box-shadow:0 0 0 1px rgba(36,151,73,.2)}" +
      "@media (max-width:600px){.ilm-mt-controls{flex-direction:column;align-items:flex-start}.ilm-mt-status{margin-left:0}}"
  );

  function injectCss(cssText) {
    var style = document.createElement("style");
    style.type = "text/css";
    style.appendChild(document.createTextNode(cssText));
    document.head.appendChild(style);
  }

  // Fetch data dari API
  var API_URL =
    "https://api.alquran.cloud/v1/surah/" +
    CONFIG.surahId +
    "/editions/quran-uthmani,ms.basmeih,en.transliteration,ar.alafasy";

  fetch(API_URL)
    .then(function (res) {
      return res.json();
    })
    .then(function (json) {
      if (!json || json.code !== 200) throw new Error("API error");
      buildAyahList(json.data);
      bindHeaderControls();
    })
    .catch(function () {
      var listEl = $('[data-role="ayah-list"]', container);
      if (listEl) {
        listEl.innerHTML =
          "<p>Maaf, berlaku ralat memuatkan data Surah Al-Muzzammil. Sila cuba refresh halaman.</p>";
      }
    });

  function buildAyahList(datasets) {
    var arab = datasets[0].ayahs || [];
    var ms = datasets[1].ayahs || [];
    var rumi = datasets[2].ayahs || [];
    var audioSet = datasets[3].ayahs || [];

    var total = arab.length;
    state.ayahs = [];

    var html = "";

    for (var i = 0; i < total; i++) {
      var ay = {
        index: i,
        numberInSurah: arab[i].numberInSurah,
        arabic: arab[i].text,
        ms: (ms[i] && ms[i].text) || "",
        rumi: (rumi[i] && rumi[i].text) || "",
        audio: (audioSet[i] && audioSet[i].audio) || ""
      };

      state.ayahs.push(ay);

      html +=
        '<article class="ilm-mt-ayah" data-idx="' +
        i +
        '">' +
        '  <div class="ilm-mt-ayah-header">' +
        '    <span class="ilm-mt-ayah-num">Ayat ' +
        ay.numberInSurah +
        "</span>" +
        '    <div class="ilm-mt-ayah-actions">' +
        '      <button type="button" class="ilm-mt-ayah-btn" data-role="play-ayah" data-idx="' +
        i +
        '">‚ñ∂ Play</button>' +
        '      <button type="button" class="ilm-mt-ayah-btn ghost" data-role="pause-ayah" data-idx="' +
        i +
        '">‚è∏ Stop</button>' +
        "    </div>" +
        "  </div>" +
        '  <div class="ilm-mt-ayah-ar">' +
        ay.arabic +
        "</div>" +
        '  <div class="ilm-mt-ayah-rumi">' +
        ay.rumi +
        "</div>" +
        '  <div class="ilm-mt-ayah-ms">' +
        ay.ms +
        "</div>" +
        "</article>";
    }

    var listEl = $('[data-role="ayah-list"]', container);
    if (listEl) listEl.innerHTML = html;

    // Delegate event untuk butang play/pause ayat
    listEl.addEventListener("click", function (e) {
      var btn = e.target.closest("button");
      if (!btn) return;
      var idx = parseInt(btn.getAttribute("data-idx"), 10);
      if (isNaN(idx)) return;

      if (btn.getAttribute("data-role") === "play-ayah") {
        state.mode = "single";
        updateModeRadios();
        playAyah(idx, true);
      } else if (btn.getAttribute("data-role") === "pause-ayah") {
        if (state.currentIndex === idx) {
          stopPlayback();
        }
      }
    });
  }

  function bindHeaderControls() {
    var playAllBtn = $('[data-role="play-all"]', container);
    var pauseAllBtn = $('[data-role="pause-all"]', container);
    var autoplayToggle = $('[data-role="autoplay-toggle"]', container);
    var modeRadios = $all('input[name="mt-mode"]', container);

    if (playAllBtn) {
      playAllBtn.addEventListener("click", function () {
        state.mode = "all";
        updateModeRadios();
        playAyah(0, true);
      });
    }

    if (pauseAllBtn) {
      pauseAllBtn.addEventListener("click", function () {
        stopPlayback();
      });
    }

    if (autoplayToggle) {
      autoplayToggle.addEventListener("change", function (e) {
        state.autoplay = !!e.target.checked;
        updateStatusText();
      });
    }

    modeRadios.forEach(function (radio) {
      radio.addEventListener("change", function (e) {
        if (e.target.checked) {
          state.mode = e.target.value === "single" ? "single" : "all";
          updateStatusText();
        }
      });
    });

    updateUiButtons();
    updateStatusText();
  }

  function updateModeRadios() {
    var modeRadios = $all('input[name="mt-mode"]', container);
    modeRadios.forEach(function (r) {
      r.checked = r.value === state.mode;
    });
  }

  function playAyah(idx, scrollIntoView) {
    if (!state.ayahs[idx] || !state.ayahs[idx].audio) return;

    state.currentIndex = idx;
    audio.src = state.ayahs[idx].audio;
    audio.play().then(
      function () {
        state.isPlaying = true;
        highlightCurrentAyah();
        updateUiButtons();
        updateStatusText();
        if (scrollIntoView) {
          scrollCurrentIntoView();
        }
      },
      function () {
        state.isPlaying = false;
        updateUiButtons();
        updateStatusText("Ralat memainkan audio. Sila cuba lagi.");
      }
    );
  }

  function stopPlayback() {
    audio.pause();
    audio.currentTime = 0;
    state.isPlaying = false;
    state.currentIndex = null;
    removeAyahHighlight();
    updateUiButtons();
    updateStatusText("Dihentikan.");
  }

  function handleEnded() {
    if (!state.autoplay) {
      state.isPlaying = false;
      updateUiButtons();
      updateStatusText("Selesai memainkan ayat " + getCurrentAyatLabel() + ".");
      return;
    }

    if (state.mode === "single") {
      state.isPlaying = false;
      updateUiButtons();
      updateStatusText("Selesai memainkan ayat " + getCurrentAyatLabel() + ".");
      return;
    }

    if (state.currentIndex == null) return;
    var next = state.currentIndex + 1;
    if (next >= state.ayahs.length) {
      state.isPlaying = false;
      state.currentIndex = null;
      removeAyahHighlight();
      updateUiButtons();
      updateStatusText("Selesai Surah Al-Muzzammil.");
      return;
    }

    playAyah(next, true);
  }

  function getCurrentAyatLabel() {
    if (state.currentIndex == null || !state.ayahs[state.currentIndex])
      return "";
    return "Ayat " + state.ayahs[state.currentIndex].numberInSurah;
  }

  function updateUiButtons() {
    var playAllBtn = $('[data-role="play-all"]', container);
    var pauseAllBtn = $('[data-role="pause-all"]', container);

    if (playAllBtn) {
      playAllBtn.disabled = state.isPlaying && state.mode === "all";
    }
    if (pauseAllBtn) {
      pauseAllBtn.disabled = !state.isPlaying;
    }
  }

  function updateStatusText(custom) {
    var el = $('[data-role="current-status"]', container);
    if (!el) return;

    if (custom) {
      setText(el, custom);
      return;
    }

    if (!state.isPlaying) {
      setText(
        el,
        "Sedia dimainkan ¬∑ Mod: " +
          (state.mode === "all" ? "Main semua ayat" : "Main ayat dipilih") +
          (state.autoplay ? " ¬∑ Auto play ON" : " ¬∑ Auto play OFF")
      );
    } else {
      setText(
        el,
        "Sedang main " +
          getCurrentAyatLabel() +
          " ¬∑ " +
          (state.autoplay
            ? "Auto play aktif"
            : "Auto play tidak diaktifkan")
      );
    }
  }

  function highlightCurrentAyah() {
    removeAyahHighlight();
    if (state.currentIndex == null) return;

    var card = container.querySelector(
      '.ilm-mt-ayah[data-idx="' + state.currentIndex + '"]'
    );
    if (card) {
      card.classList.add("active");
    }
  }

  function removeAyahHighlight() {
    $all(".ilm-mt-ayah.active", container).forEach(function (c) {
      c.classList.remove("active");
    });
  }

  function scrollCurrentIntoView() {
    if (state.currentIndex == null) return;
    var card = container.querySelector(
      '.ilm-mt-ayah[data-idx="' + state.currentIndex + '"]'
    );
    if (card && typeof card.scrollIntoView === "function") {
      card.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }
})();
