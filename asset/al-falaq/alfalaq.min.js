(function() {
  const AYAT_DATA = [
    {
      num: 1,
      arab: "Ù‚ÙÙ„Ù’ Ø£ÙŽØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙŽØ¨Ù‘Ù Ù±Ù„Ù’ÙÙŽÙ„ÙŽÙ‚Ù",
      rumi: "Qul aâ€˜uzu bi rabbil-falaq",
      ms: "Katakanlah (wahai Muhammad): \"Aku berlindung kepada Tuhan yang menguasai waktu subuh (cahaya yang memecah kegelapan).\""
    },
    {
      num: 2,
      arab: "Ù…ÙÙ† Ø´ÙŽØ±Ù‘Ù Ù…ÙŽØ§ Ø®ÙŽÙ„ÙŽÙ‚ÙŽ",
      rumi: "Min sharri ma khalaq",
      ms: "Daripada kejahatan segala makhluk yang Dia ciptakan."
    },
    {
      num: 3,
      arab: "ÙˆÙŽÙ…ÙÙ† Ø´ÙŽØ±Ù‘Ù ØºÙŽØ§Ø³ÙÙ‚Ù Ø¥ÙØ°ÙŽØ§ ÙˆÙŽÙ‚ÙŽØ¨ÙŽ",
      rumi: "Wa min sharri ghasiqin iza waqab",
      ms: "Dan daripada kejahatan malam apabila ia gelap-gelita (atau apabila kegelapan itu menyelubungi)."
    },
    {
      num: 4,
      arab: "ÙˆÙŽÙ…ÙÙ† Ø´ÙŽØ±Ù‘Ù Ù±Ù„Ù†Ù‘ÙŽÙÙ‘ÙŽØ§Ø«ÙŽØ§ØªÙ ÙÙÙ‰ Ù±Ù„Ù’Ø¹ÙÙ‚ÙŽØ¯Ù",
      rumi: "Wa min sharri an-naffathati fil-â€˜uqad",
      ms: "Dan daripada kejahatan tukang-tukang sihir perempuan yang meniup pada buhul-buhul (ikatan-ikatan sihir)."
    },
    {
      num: 5,
      arab: "ÙˆÙŽÙ…ÙÙ† Ø´ÙŽØ±Ù‘Ù Ø­ÙŽØ§Ø³ÙØ¯Ù Ø¥ÙØ°ÙŽØ§ Ø­ÙŽØ³ÙŽØ¯ÙŽ",
      rumi: "Wa min sharri á¸¥asidin iza á¸¥asad",
      ms: "Dan daripada kejahatan orang yang dengki apabila dia melakukan hasadnya."
    }
  ];

  let initialized = false;
  function initSurahFalaqTool() {
    if (initialized) return;
    initialized = true;

    const wrapper = document.getElementById("surah-alfalaq-wrapper");
    const ayatList = document.getElementById("sf-ayat-list");
    const audio = document.getElementById("sf-audio");
    const playMain = document.getElementById("sf-main-play");
    const ruqyahBtn = document.getElementById("sf-play-ruqyah");
    const slowBtn = document.getElementById("sf-toggle-slow");
    const slowBadge = document.getElementById("sf-slow-badge");
    const childBtn = document.getElementById("sf-toggle-child");
    const nightBtn = document.getElementById("sf-toggle-night");
    const modeSelect = document.getElementById("sf-mode-select");
    const progressBar = document.getElementById("sf-progress");
    const progressFill = document.getElementById("sf-progress-fill");
    const timeLabel = document.getElementById("sf-time");

    if (!wrapper || !ayatList || !audio) return;

    let ruqyahTarget = 0;
    let ruqyahCount = 0;
    let rafId = null;
    let segmentDur = null;
    let slowMode = false;
    let activeAyatIndex = -1;

    // Restore night mode from localStorage
    try {
      const storedNight = localStorage.getItem("ilmu_sf_night");
      if (storedNight === "1") {
        wrapper.classList.add("ilmu-sf-night");
      }
    } catch(e) {}

    // === Render ayat list ===
    function renderAyatList(mode) {
      ayatList.innerHTML = "";
      AYAT_DATA.forEach((a, idx) => {
        const div = document.createElement("div");
        div.className = "ilmu-sf-ayat";
        div.dataset.index = idx;

        let inner = "";
        inner += '<div class="ilmu-sf-ayat-num">Ayat ' + a.num + "</div>";

        if (mode !== "hafal") {
          inner += '<div class="ilmu-sf-ayat-arab">' + a.arab + "</div>";
        }
        if (mode !== "kuiz") {
          inner += '<div class="ilmu-sf-ayat-rumi">' + a.rumi + "</div>";
          inner += '<div class="ilmu-sf-ayat-ms">' + a.ms + "</div>";
        } else {
          inner += '<div class="ilmu-sf-ayat-rumi" style="opacity:.4;">(Tutup teks - cuba ingat sendiri)</div>';
          inner += '<div class="ilmu-sf-ayat-ms" style="opacity:.4;">Klik untuk reveal jawapan</div>';
        }

        div.innerHTML = inner;
        ayatList.appendChild(div);
      });
    }

    // Initial render
    renderAyatList(modeSelect.value);

    // Format time
    function fmt(sec) {
      if (!isFinite(sec) || sec < 0) return "00:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    }

    // Highlight ayat mengikut masa
    function highlightByTime() {
      if (!audio.duration || !segmentDur) return;
      const idx = Math.min(
        AYAT_DATA.length - 1,
        Math.floor(audio.currentTime / segmentDur)
      );
      if (idx !== activeAyatIndex) {
        activeAyatIndex = idx;
        const items = ayatList.querySelectorAll(".ilmu-sf-ayat");
        items.forEach((item, i) => {
          item.classList.toggle("ilmu-sf-ayat-active", i === idx);
        });
        // Auto scroll
        const activeEl = items[idx];
        if (activeEl && ayatList.scrollHeight > ayatList.clientHeight) {
          const top = activeEl.offsetTop - ayatList.clientHeight / 3;
          ayatList.scrollTo({ top: top < 0 ? 0 : top, behavior: "smooth" });
        }
      }
    }

    function updateProgress() {
      if (!audio.duration) {
        timeLabel.textContent = "00:00 / 00:00";
      } else {
        const pct = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = pct + "%";
        timeLabel.textContent = fmt(audio.currentTime) + " / " + fmt(audio.duration);
        highlightByTime();
      }
      rafId = requestAnimationFrame(updateProgress);
    }

    // Audio events
    audio.addEventListener("loadedmetadata", function() {
      if (audio.duration && AYAT_DATA.length) {
        segmentDur = audio.duration / AYAT_DATA.length;
      }
      timeLabel.textContent = "00:00 / " + fmt(audio.duration || 0);
    });

    audio.addEventListener("play", function() {
      playMain.textContent = "â¸";
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(updateProgress);
    });

    audio.addEventListener("pause", function() {
      playMain.textContent = "â–¶";
      if (rafId) cancelAnimationFrame(rafId);
    });

    audio.addEventListener("ended", function() {
      if (rafId) cancelAnimationFrame(rafId);
      progressFill.style.width = "0%";
      timeLabel.textContent = "00:00 / " + fmt(audio.duration || 0);
      activeAyatIndex = -1;
      const items = ayatList.querySelectorAll(".ilmu-sf-ayat");
      items.forEach(item => item.classList.remove("ilmu-sf-ayat-active"));
      playMain.textContent = "â–¶";

      // Logik Ruqyah 3x
      if (ruqyahTarget > 0) {
        ruqyahCount++;
        if (ruqyahCount < ruqyahTarget) {
          audio.currentTime = 0;
          audio.play();
        } else {
          ruqyahTarget = 0;
          ruqyahCount = 0;
          ruqyahBtn.textContent = "ðŸ” Ruqyah 3x";
        }
      }
    });

    // Main play/pause button
    playMain.addEventListener("click", function() {
      if (audio.paused) audio.play(); else audio.pause();
    });

    // Seek
    progressBar.addEventListener("click", function(e) {
      if (!audio.duration) return;
      const rect = progressBar.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      audio.currentTime = Math.min(Math.max(ratio,0),1) * audio.duration;
      if (segmentDur == null && audio.duration && AYAT_DATA.length) {
        segmentDur = audio.duration / AYAT_DATA.length;
      }
      updateProgress();
    });

    // Klik ayat: fokus highlight + sedikit "snap" masa ikut indeks
    ayatList.addEventListener("click", function(e) {
      const ayatEl = e.target.closest(".ilmu-sf-ayat");
      if (!ayatEl) return;
      const idx = parseInt(ayatEl.dataset.index, 10);
      const mode = modeSelect.value;

      if (mode === "kuiz") {
        // reveal jawapan
        const data = AYAT_DATA[idx];
        ayatEl.innerHTML =
          '<div class="ilmu-sf-ayat-num">Ayat ' + data.num + "</div>" +
          '<div class="ilmu-sf-ayat-arab">' + data.arab + "</div>" +
          '<div class="ilmu-sf-ayat-rumi">' + data.rumi + "</div>" +
          '<div class="ilmu-sf-ayat-ms">' + data.ms + "</div>";
      } else {
        // simple: lompat ke segmen mengikut nisbah (tanpa timecode spesifik)
        if (audio.duration && segmentDur) {
          audio.currentTime = segmentDur * idx + 0.1;
          if (audio.paused) audio.play();
          highlightByTime();
        } else {
          // jika duration belum load, hanya highlight sahaja
          const items = ayatList.querySelectorAll(".ilmu-sf-ayat");
          items.forEach((it, i) => it.classList.toggle("ilmu-sf-ayat-active", i === idx));
        }
      }
    });

    // Ruqyah 3x
    ruqyahBtn.addEventListener("click", function() {
      ruqyahTarget = 3;
      ruqyahCount = 0;
      audio.currentTime = 0;
      audio.play();
      this.textContent = "âœ… Ruqyah 3x (Sedang Main)";
    });

    // Slow toggle
    slowBtn.addEventListener("click", function() {
      slowMode = !slowMode;
      audio.playbackRate = slowMode ? 0.8 : 1.0;
      slowBadge.textContent = slowMode ? "ON" : "OFF";
      slowBadge.style.background = slowMode ? "#0c3808" : "#ecfdfa";
      slowBadge.style.color = slowMode ? "#fff" : "#0c3808";
    });

    // Child mode
    childBtn.addEventListener("click", function() {
      wrapper.classList.toggle("ilmu-sf-child");
    });

    // Night mode
    nightBtn.addEventListener("click", function() {
      wrapper.classList.toggle("ilmu-sf-night");
      try {
        localStorage.setItem("ilmu_sf_night",
          wrapper.classList.contains("ilmu-sf-night") ? "1" : "0"
        );
      } catch(e) {}
    });

    // Mode select
    modeSelect.addEventListener("change", function() {
      renderAyatList(this.value);
      activeAyatIndex = -1;
    });
  }

  if (document.readyState === "complete" || document.readyState === "interactive") {
    initSurahFalaqTool();
  } else {
    document.addEventListener("DOMContentLoaded", initSurahFalaqTool);
  }
})();
